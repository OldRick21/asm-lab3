# Документация к ассемблерной программе шифрования Цезаря (обновленная версия)

## Секция `.data`

### Буферы ввода/вывода
```asm
buffer times 255 db 0
b_size equ $ - buffer
buffer2 times 255 db 0
b2_size equ $ - buffer2
filename_buffer times 256 db 0
filename_ptr dq 0
```
- **Назначение**:
  - `buffer` - хранение исходных данных
  - `buffer2` - хранение обработанных данных после фильтрации пробелов
  - `filename_buffer` - буфер для хранения имени файла
- **Детали**:
  - Все буферы имеют автоматический расчет размера через `equ $ -`
  - `filename_ptr` хранит 64-битный указатель на имя файла

### Конфигурационные параметры
```asm
prompt db "Enter filename: "
prompt_len equ $ - prompt
offset db 33
```
- **prompt**: Приглашение для ввода имени файла
- **offset**: Смещение для шифра (33 → 7 после нормализации)

## Секция `.text`

### Инициализация программы
```asm
global _start
_start:
    ; Вывод приглашения
    mov rax, 1
    mov rdi, 1
    mov rsi, prompt
    mov rdx, prompt_len
    syscall

    ; Чтение имени файла
    mov rax, 0
    mov rdi, 0
    mov rsi, filename_buffer
    mov rdx, 256
    syscall

    ; Обработка перевода строки
    mov rdi, filename_buffer
    call replace_newline
    mov qword [filename_ptr], filename_buffer
    
    mov r14, 2
    jmp sys_read
```
- **Новые функции**:
  - Интерактивный ввод имени файла
  - Замена `\n` на нуль-терминатор в имени файла
  - Сохранение указателя через 64-битную операцию

### Подсистема чтения данных
```asm
sys_read:
    ; Чтение из stdin (без изменений)
    ...
```
- **Безопасность**:
  - Проверка размера буфера через `b_size`
  - Обработка EOF через `rax == 0`

### Алгоритм шифрования (без изменений)
```asm
; Логика обработки символов сохраняется
...
```

### Запись в файл (обновлено)
```asm
sys_file_write:
    mov rax, 2
    mov rdi, [filename_ptr]  ; Использование динамического указателя
    mov rsi, 0x441           ; O_WRONLY|O_CREAT|O_APPEND
    mov rdx, 0755o
    syscall
```
- **Ключевые изменения**:
  - Использование `filename_ptr` вместо статического имени
  - Динамический адрес файла из пользовательского ввода

### Обработка ошибок (обновлено)
```asm
error_open:
    ; Удалены обработчики error_args
    ...
```
- **Упрощенная модель ошибок**:
  - Сохранены только ошибки работы с файлом
  - Удалена проверка аргументов командной строки

## Новые особенности реализации
1. **Интерактивный интерфейс**:
   - Приглашение для ввода имени файла
   - Поддержка длинных имен (до 255 символов)

2. **Безопасный ввод**:
   - Очистка символа новой строки
   - Гарантированный нуль-терминатор

3. **Динамическое имя файла**:
   - Возможность указания разных файлов без перекомпиляции
   - Поддержка полных путей

4. **64-битная адресация**:
   - Корректная работа с указателями в современных ОС
   - Явное указание размера памяти через `qword`

## Пример использования
```bash
$ ./program
Enter filename: secret.txt
Hello World!
^D

$ cat secret.txt
Gdkkn Vnqkc!
```

## Схема работы
```
[Ввод имени файла] → [Чтение данных] → [Шифрование] 
→ [Фильтрация пробелов] → [Запись в файл]
```